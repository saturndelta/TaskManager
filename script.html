// --- DOM Elements ---
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const userInfo = document.getElementById('userInfo');
const loggedInUserSpan = document.getElementById('loggedInUser');
const logoutButton = document.getElementById('logoutButton');
const loginSection = document.getElementById('loginSection');
const taskSection = document.getElementById('taskSection');
const taskForm = document.getElementById('taskForm');
const taskFormErrorP = document.getElementById('taskFormError');
const taskListDiv = document.getElementById('taskList');
const assignToSelect = document.getElementById('assignTo');
const statusFilter = document.getElementById('statusFilter');
const userFilter = document.getElementById('userFilter');
const editModal = document.getElementById('editTaskModal');
const closeButton = document.querySelector('.close-button');
const editTaskForm = document.getElementById('editTaskForm');
const editTaskIdInput = document.getElementById('editTaskId');
const editVideoLinkInput = document.getElementById('editVideoLink');
const editTaskDescriptionTextarea = document.getElementById('editTaskDescription');
const editSolutionTextarea = document.getElementById('editSolution');
const editAssignToSelect = document.getElementById('editAssignTo');
const editStatusSelect = document.getElementById('editStatus');
const editTaskErrorP = document.getElementById('editTaskError');

// --- Global Variables ---
let allTasks = [];
let availableUsers = [];

// --- Authentication ---
loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    loginError.textContent = '';
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                localStorage.setItem('loggedInUser', username);
                checkLoginStatus();
            } else {
                loginError.textContent = result.message || 'Login failed. Please try again.';
            }
        })
        .withFailureHandler(function(error) {
            loginError.textContent = error.message || 'Login failed. Please try again.';
        })
        .loginUser(username, password);
});

logoutButton.addEventListener('click', function() {
    localStorage.removeItem('loggedInUser');
    checkLoginStatus();
});

function checkLoginStatus() {
    const currentUser = localStorage.getItem('loggedInUser');
    
    if (currentUser) {
        loggedInUserSpan.textContent = currentUser;
        userInfo.style.display = 'block';
        loginSection.style.display = 'none';
        taskSection.style.display = 'block';
        
        // Load tasks and users
        fetchUsers();
        fetchAndRenderTasks();
    } else {
        userInfo.style.display = 'none';
        loginSection.style.display = 'block';
        taskSection.style.display = 'none';
    }
}

function fetchUsers() {
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                availableUsers = result.users || [];
                
                // Populate user dropdowns
                populateUserDropdown(assignToSelect, availableUsers);
                populateUserDropdown(userFilter, availableUsers, true);
            }
        })
        .getUsersList();
}

function populateUserDropdown(selectElement, users, includeAll = false) {
    // Clear existing options except the first one
    while (selectElement.options.length > 1) {
        selectElement.remove(1);
    }
    
    // Add "Unassigned" option for user filter
    if (selectElement.id === "userFilter") {
        const unassignedOption = document.createElement('option');
        unassignedOption.value = "";
        unassignedOption.textContent = "Unassigned";
        selectElement.appendChild(unassignedOption);
    }
    
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        selectElement.appendChild(option);
    });
}

// --- Task Management ---
taskForm.addEventListener('submit', function(e) {
    e.preventDefault();
    taskFormErrorP.textContent = '';
    const currentUser = localStorage.getItem('loggedInUser');
    if (!currentUser) {
        taskFormErrorP.textContent = "You must be logged in to add tasks.";
        return;
    }

    const taskData = {
        videoLink: document.getElementById('videoLink').value,
        taskDescription: document.getElementById('taskDescription').value,
        whoIsWorkingOn: assignToSelect.value,
        status: "Open" // Default status
    };

    if (!taskData.taskDescription) {
        taskFormErrorP.textContent = "Task description is required.";
        return;
    }

    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                if (result.task) {
                    allTasks.push(result.task);
                    renderTasks();
                } else {
                    fetchAndRenderTasks(); // Fallback to refetch all if new task data isn't returned fully
                }
                taskForm.reset();
            } else {
                taskFormErrorP.textContent = result.message || 'Failed to add task.';
            }
        })
        .withFailureHandler(function(error) {
            taskFormErrorP.textContent = error.message || 'Failed to add task.';
        })
        .addTask(taskData, currentUser);
});

function fetchAndRenderTasks() {
    const currentUser = localStorage.getItem('loggedInUser');
    if (!currentUser) return;

    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                allTasks = result.tasks.sort((a, b) => new Date(b.TimeCreated) - new Date(a.TimeCreated)); // Sort by newest first
                renderTasks();
            } else {
                taskListDiv.innerHTML = `<p class="error-message">Failed to load tasks: ${result.message}</p>`;
            }
        })
        .withFailureHandler(function(error) {
            taskListDiv.innerHTML = `<p class="error-message">Failed to load tasks: ${error.message}</p>`;
        })
        .getTasks();
}

function renderTasks() {
    taskListDiv.innerHTML = ''; // Clear current list
    if (!allTasks || allTasks.length === 0) {
        taskListDiv.innerHTML = '<p>No tasks yet. Create one!</p>';
        return;
    }

    const filteredTasks = applyFilters(allTasks);

    filteredTasks.forEach(task => {
        const taskEl = document.createElement('div');
        taskEl.classList.add('task-item');
        taskEl.classList.add(`status-${task.Status.replace(/\s+/g, '')}`); // e.g., status-InProgress
        taskEl.dataset.taskId = task.TaskID;

        let assignedToDisplay = task.WhoIsWorkingOn || 'Unassigned';
        let solutionDisplay = task.Solution ? `<p><strong>Solution:</strong> ${linkify(task.Solution)}</p>` : '<p><strong>Solution:</strong> Not provided yet.</p>';
        let videoLinkDisplay = task.VideoLink ? `<p><strong>Video Link:</strong> <a href="${task.VideoLink}" target="_blank" rel="noopener noreferrer">${task.VideoLink}</a></p>` : '';
        
        taskEl.innerHTML = `
            <h3>${escapeHTML(task.TaskDescription)}</h3>
            <div class="task-meta">
                <span><strong>Status:</strong> ${task.Status}</span>
                <span><strong>Assigned To:</strong> ${assignedToDisplay}</span>
                <span><strong>Created:</strong> ${new Date(task.TimeCreated).toLocaleString()} by ${task.CreatedBy}</span>
                <span><strong>Last Updated:</strong> ${new Date(task.LastUpdated).toLocaleString()}</span>
            </div>
            ${videoLinkDisplay}
            <p><strong>Description:</strong> ${linkify(escapeHTML(task.TaskDescription))}</p>
            ${solutionDisplay}
            <div class="task-actions">
                <button class="edit-btn">Edit / Add Solution</button>
                ${task.Status !== 'Solved' ? `<button class="solve-btn">Mark as Solved</button>` : ''}
                ${task.Status === 'Solved' && task.WhoIsWorkingOn === localStorage.getItem('loggedInUser') ? `<button class="reopen-btn">Re-open</button>` : ''}
            </div>
        `;

        // Event Listeners for task actions
        const editBtn = taskEl.querySelector('.edit-btn');
        if (editBtn) {
            editBtn.addEventListener('click', () => openEditModal(task));
        }

        const solveBtn = taskEl.querySelector('.solve-btn');
        if (solveBtn) {
            solveBtn.addEventListener('click', () => updateTaskStatus(task.TaskID, 'Solved', localStorage.getItem('loggedInUser')));
        }
        
        const reopenBtn = taskEl.querySelector('.reopen-btn');
        if (reopenBtn) {
            reopenBtn.addEventListener('click', () => updateTaskStatus(task.TaskID, 'Open', '')); // Re-open and unassign
        }

        taskListDiv.appendChild(taskEl);
    });
}

function escapeHTML(str) {
    if (str === null || str === undefined) return '';
    return str.toString().replace(/[&<>"']/g, function (match) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
        }[match];
    });
}

function linkify(text) {
    if (text === null || text === undefined) return '';
    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    return text.toString().replace(urlRegex, function(url) {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
}

function updateTaskStatus(taskId, newStatus, assignedUser = null) {
    const currentUser = localStorage.getItem('loggedInUser');
    const updates = { Status: newStatus };
    if (newStatus === 'Solved') {
        updates.WhoIsWorkingOn = assignedUser || currentUser; // Assign to current user if solving
    } else if (newStatus === 'Open' && assignedUser === '') { // For re-opening and unassigning
        updates.WhoIsWorkingOn = '';
    }

    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                // Update local cache and re-render
                const taskIndex = allTasks.findIndex(t => t.TaskID === taskId);
                if (taskIndex > -1 && result.task) {
                    allTasks[taskIndex] = result.task;
                    renderTasks();
                } else {
                    fetchAndRenderTasks(); // Fallback
                }
            } else {
                alert(`Failed to update task: ${result.message}`);
            }
        })
        .withFailureHandler(function(error) {
            alert(`Failed to update task: ${error.message}`);
        })
        .updateTask(taskId, updates, currentUser);
}

// --- Edit Modal Logic ---
function openEditModal(task) {
    editTaskIdInput.value = task.TaskID;
    editVideoLinkInput.value = task.VideoLink || '';
    editTaskDescriptionTextarea.value = task.TaskDescription || '';
    editSolutionTextarea.value = task.Solution || '';
    
    // Populate and set assigned user
    populateUserDropdown(editAssignToSelect, availableUsers, true);
    editAssignToSelect.value = task.WhoIsWorkingOn || "";

    editStatusSelect.value = task.Status || "Open";
    
    editTaskErrorP.textContent = '';
    editModal.style.display = 'block';
}

closeButton.onclick = function() {
    editModal.style.display = "none";
}

window.onclick = function(event) {
    if (event.target == editModal) {
        editModal.style.display = "none";
    }
}

editTaskForm.addEventListener('submit', function(e) {
    e.preventDefault();
    editTaskErrorP.textContent = '';
    const currentUser = localStorage.getItem('loggedInUser');

    const taskId = editTaskIdInput.value;
    const updates = {
        VideoLink: editVideoLinkInput.value,
        TaskDescription: editTaskDescriptionTextarea.value,
        Solution: editSolutionTextarea.value,
        WhoIsWorkingOn: editAssignToSelect.value,
        Status: editStatusSelect.value
    };

    if (!updates.TaskDescription) {
        editTaskErrorP.textContent = "Task description cannot be empty.";
        return;
    }

    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                // Update local cache and re-render
                const taskIndex = allTasks.findIndex(t => t.TaskID === taskId);
                if (taskIndex > -1 && result.task) {
                    allTasks[taskIndex] = result.task;
                    renderTasks();
                } else {
                    fetchAndRenderTasks(); // Fallback
                }
                editModal.style.display = "none";
            } else {
                editTaskErrorP.textContent = `Failed to update task: ${result.message}`;
            }
        })
        .withFailureHandler(function(error) {
            editTaskErrorP.textContent = `Failed to update task: ${error.message}`;
        })
        .updateTask(taskId, updates, currentUser);
});

// --- Filtering ---
statusFilter.addEventListener('change', renderTasks);
userFilter.addEventListener('change', renderTasks);

function applyFilters(tasksToFilter) {
    const selectedStatus = statusFilter.value;
    const selectedUser = userFilter.value;
    
    return tasksToFilter.filter(task => {
        const statusMatch = (selectedStatus === 'all') || (task.Status === selectedStatus);
        const userMatch = (selectedUser === 'all') || (task.WhoIsWorkingOn === selectedUser) || (selectedUser === "" && !task.WhoIsWorkingOn); // Handle "Unassigned"
        return statusMatch && userMatch;
    });
}

// --- Registration Logic ---
document.getElementById('registerLink').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('registerSection').style.display = 'block';
});

document.getElementById('loginLink').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('registerSection').style.display = 'none';
    document.getElementById('loginSection').style.display = 'block';
});

document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const registerError = document.getElementById('registerError');
    registerError.textContent = '';
    
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (password !== confirmPassword) {
        registerError.textContent = 'Passwords do not match.';
        return;
    }
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                alert('Registration successful! You can now log in.');
                document.getElementById('registerSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
            } else {
                registerError.textContent = result.message || 'Registration failed. Please try again.';
            }
        })
        .withFailureHandler(function(error) {
            registerError.textContent = error.message || 'Registration failed. Please try again.';
        })
        .registerUser(username, password);
});

// --- Initial Load ---
checkLoginStatus();